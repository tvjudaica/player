<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TV Judaica</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: black;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .player-wrapper {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: black;
      position: relative;
    }

    .tv-frame {
      width: 100%;
      max-width: calc(100vh * 16 / 9);
      max-height: 100vh;
      aspect-ratio: 16 / 9;
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: black;
      border: none;
    }

    /* Overlay só aparece se autoplay falhar */
    .overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 16px;
      user-select: none;
      -webkit-user-select: none;
      cursor: pointer;
    }
    .overlay.show { display: flex; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>

<body>
  teste
  <div class="player-wrapper">
    <div class="tv-frame">
      <!-- Começa sem controls para aumentar chance de autoplay no iOS -->
      <video id="video" autoplay muted playsinline webkit-playsinline preload="auto"></video>
      <div id="overlay" class="overlay">
        Toque para iniciar o vídeo
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const stream = 'https://br5093.streamingdevideo.com.br/tvjudaica/tvjudaica/playlist.m3u8';

    let hls;
    let controlsEnabled = false;
    let audioUnlocked = false;

    function showOverlay() { overlay.classList.add('show'); }
    function hideOverlay() { overlay.classList.remove('show'); }

    function ensureInlineAutoplayFlags() {
      // iOS/WKWebView: essas flags precisam estar sempre setadas
      video.muted = true;
      video.defaultMuted = true;
      video.setAttribute('muted', '');

      video.playsInline = true;
      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
    }

    function enableControlsOncePlaying() {
      if (controlsEnabled) return;
      // Mostrar controls só depois de tocar ajuda o autoplay no iOS
      video.controls = false;
      video.addEventListener('playing', () => {
        controlsEnabled = true;
        video.controls = true;
      }, { once: true });
    }

    async function tryPlay(label) {
      ensureInlineAutoplayFlags();
      enableControlsOncePlaying();

      try {
        const p = video.play();
        if (p && typeof p.then === 'function') await p;
        hideOverlay();
        return true;
      } catch (e) {
        // Autoplay bloqueado
        // console.log('play bloqueado em', label, e);
        showOverlay();
        return false;
      }
    }

    function attachRetryEvents() {
      const retry = () => tryPlay('retry-event');
      video.addEventListener('loadedmetadata', retry, { once: true });
      video.addEventListener('loadeddata', retry, { once: true });
      video.addEventListener('canplay', retry, { once: true });
      video.addEventListener('canplaythrough', retry, { once: true });
    }

    function startStream() {
      ensureInlineAutoplayFlags();
      attachRetryEvents();

      if (Hls.isSupported()) {
        if (hls) {
          try { hls.destroy(); } catch {}
        }

        hls = new Hls({
          enableWorker: true,
          lowLatencyMode: true,
        });

        hls.loadSource(stream);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          tryPlay('manifest-parsed');
        });

      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // iOS Safari/WKWebView: HLS nativo
        video.src = stream;

        // tentar imediatamente após setar src ajuda no iOS
        tryPlay('ios-src-set');
      } else {
        alert('Seu navegador não suporta reprodução de vídeo HLS.');
      }
    }

    // Desbloquear áudio no primeiro toque em QUALQUER lugar (não precisa apertar play)
    async function unlockAudio() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      // iOS exige gesto do usuário para tirar o mute
      video.muted = false;
      video.removeAttribute('muted');
      video.volume = 1.0;

      // garante que está tocando após desbloqueio
      await tryPlay('audio-unlock');
    }

    function bindGlobalUnlock() {
      // qualquer toque/clique na tela desbloqueia
      document.addEventListener('touchstart', unlockAudio, { once: true, passive: true });
      document.addEventListener('click', unlockAudio, { once: true });
    }

    // Overlay ainda funciona (caso o iOS bloqueie tudo)
    function bindOverlayUnlock() {
      overlay.addEventListener('click', async () => {
        await tryPlay('overlay-click');
      });
      overlay.addEventListener('touchstart', async () => {
        await tryPlay('overlay-touch');
      }, { passive: true });
    }

    window.addEventListener('load', () => {
      bindGlobalUnlock();
      bindOverlayUnlock();
      startStream();
      document.body.focus();
    });

    // Teclado (mantive)
    document.addEventListener('keydown', function (event) {
      switch (event.keyCode) {
        case 13:
          video.muted = !video.muted;
          break;
        case 32:
          if (video.paused) video.play();
          else video.pause();
          break;
      }
    });
  </script>
</body>
</html>